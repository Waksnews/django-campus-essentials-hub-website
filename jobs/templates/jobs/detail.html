{% extends 'core/base.html' %}
{% load static %}
{% load humanize %}
{% load job_filters %}
{% block title %}{{ job.title }} - Campus Jobs{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'jobs:list' %}">Jobs</a></li>
            <li class="breadcrumb-item"><a href="{% url 'jobs:list' %}?category={{ job.category }}">{{ job.get_category_display }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ job.title|truncatechars:30 }}</li>
        </ol>
    </nav>

    <!-- Main Job Card -->
    <div class="row">
        <div class="col-lg-8">
            <!-- Job Header -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <span class="badge bg-{{ job.category|get_category_color }} mb-2">
                                <i class="fas fa-{{ job.category|get_category_icon }} me-1"></i>
                                {{ job.get_category_display }}
                            </span>
                            <h1 class="h2 fw-bold mb-2">{{ job.title }}</h1>
                            <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
                                <span class="text-muted">
                                    <i class="fas fa-map-marker-alt me-1"></i>{{ job.location }}
                                </span>
                                <span class="text-muted">
                                    <i class="fas fa-user me-1"></i>Posted by {{ job.user.get_full_name|default:job.user.username }}
                                </span>
                                <span class="text-muted">
                                    <i class="fas fa-clock me-1"></i>{{ job.created_at|timesince }} ago
                                </span>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="mb-2">
                                <span class="badge {% if job.budget_type == 'fixed' %}bg-success{% else %}bg-warning{% endif %} p-3 fs-6">
                                    {% if job.budget_type == 'fixed' %}
                                    <i class="fas fa-dollar-sign me-1"></i>${{ job.budget|floatformat:2 }}
                                    {% else %}
                                    <i class="fas fa-clock me-1"></i>${{ job.budget|floatformat:2 }}/hr
                                    {% endif %}
                                </span>
                            </div>
                            {% if job.duration %}
                            <div class="text-muted small">
                                <i class="fas fa-calendar me-1"></i>{{ job.duration }}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Job Status Badge -->
                    <div class="mb-4">
                        <span class="badge {% if job.status == 'open' %}bg-success{% elif job.status == 'in_progress' %}bg-primary{% elif job.status == 'completed' %}bg-secondary{% else %}bg-danger{% endif %}">
                            {{ job.get_status_display }}
                        </span>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex flex-wrap gap-2 mb-4">
                        {% if user.is_authenticated %}
                            {% if is_owner %}
                                <a href="{% url 'jobs:applications' job.id %}" class="btn btn-primary">
                                    <i class="fas fa-users me-2"></i>View Applications
                                    {% if applications %}
                                    <span class="badge bg-white text-primary ms-2">{{ applications.count }}</span>
                                    {% endif %}
                                </a>
                                <a href="{% url 'jobs:update' job.id %}" class="btn btn-outline-primary">
                                    <i class="fas fa-edit me-2"></i>Edit Job
                                </a>
                                <a href="{% url 'jobs:delete' job.id %}" class="btn btn-outline-danger">
                                    <i class="fas fa-trash me-2"></i>Delete
                                </a>
                            {% else %}
                                {% if not has_applied %}
                                    {% if job.status == 'open' %}
                                    <a href="{% url 'jobs:apply' job.id %}" class="btn btn-success">
                                        <i class="fas fa-paper-plane me-2"></i>Apply Now
                                    </a>
                                    {% else %}
                                    <button class="btn btn-secondary" disabled>
                                        <i class="fas fa-ban me-2"></i>Not Accepting Applications
                                    </button>
                                    {% endif %}
                                {% else %}
                                    {% if user_application %}
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-{{ user_application.get_status_color }} me-2">
                                            {{ user_application.get_status_display }}
                                        </span>
                                        <a href="{% url 'jobs:withdraw_application' user_application.id %}" class="btn btn-outline-danger btn-sm">
                                            <i class="fas fa-times me-1"></i>Withdraw
                                        </a>
                                    </div>
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        {% else %}
                            <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="btn btn-primary">
                                <i class="fas fa-sign-in-alt me-2"></i>Login to Apply
                            </a>
                        {% endif %}

                        <!-- Save Job Button -->
                        <button class="btn btn-outline-secondary" id="saveJobBtn">
                            <i class="far fa-bookmark me-2"></i>Save Job
                        </button>

                        <!-- Share Button -->
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-share-alt me-2"></i>Share
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" id="shareFacebook"><i class="fab fa-facebook me-2"></i>Facebook</a></li>
                                <li><a class="dropdown-item" href="#" id="shareTwitter"><i class="fab fa-twitter me-2"></i>Twitter</a></li>
                                <li><a class="dropdown-item" href="#" id="copyLink"><i class="fas fa-link me-2"></i>Copy Link</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Job Description -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-align-left me-2"></i>Job Description</h5>
                </div>
                <div class="card-body">
                    <div class="job-description">
                        {{ job.description|linebreaks }}
                    </div>
                </div>
            </div>

            <!-- Skills Required -->
            {% if job.skills_required %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Skills Required</h5>
                </div>
                <div class="card-body">
                    <div class="skills-container">
                        {% for skill in job.skills_required|split:"," %}
                            {% if skill.strip %}
                            <span class="badge bg-light text-dark border p-2 m-1 fs-6">
                                <i class="fas fa-check-circle text-success me-1"></i>{{ skill.strip }}
                            </span>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- About the Employer -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-user-tie me-2"></i>About the Employer</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-start">
                        <div class="flex-shrink-0">
                            <div class="avatar-circle bg-primary text-white">
                                {{ job.user.username|first|upper }}
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-1">{{ job.user.get_full_name|default:job.user.username }}</h6>
                            <p class="text-muted small mb-2">Member since {{ job.user.date_joined|date:"M Y" }}</p>

                            {% if is_owner %}
                            <div class="d-flex gap-2">
                                <span class="badge bg-info">
                                    <i class="fas fa-briefcase me-1"></i>{{ job.user.posted_jobs.count }} jobs posted
                                </span>
                                <span class="badge bg-secondary">
                                    <i class="fas fa-star me-1"></i>4.8/5 rating
                                </span>
                            </div>
                            {% endif %}

                            {% if not is_owner and user.is_authenticated %}
                            <button class="btn btn-outline-primary btn-sm mt-2">
                                <i class="fas fa-envelope me-1"></i>Message Employer
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Application Stats (For Owners) -->
            {% if is_owner and applications %}
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Application Stats</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col">
                            <div class="stat-card bg-success bg-opacity-10 p-3 rounded">
                                <h3 class="text-success mb-1">{{ applications.count }}</h3>
                                <p class="text-muted small mb-0">Total Applications</p>
                            </div>
                        </div>
                        <div class="col">
                            <div class="stat-card bg-warning bg-opacity-10 p-3 rounded">
                                <h3 class="text-warning mb-1">{{ applications|filter_status:'pending'|length }}</h3>
                                <p class="text-muted small mb-0">Pending Review</p>
                            </div>
                        </div>
                        <div class="col">
                            <div class="stat-card bg-primary bg-opacity-10 p-3 rounded">
                                <h3 class="text-primary mb-1">{{ applications|filter_status:'accepted'|length }}</h3>
                                <p class="text-muted small mb-0">Accepted</p>
                            </div>
                        </div>
                        <div class="col">
                            <div class="stat-card bg-info bg-opacity-10 p-3 rounded">
                                <h3 class="text-info mb-1">{{ applications|filter_status:'rejected'|length }}</h3>
                                <p class="text-muted small mb-0">Rejected</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Info Card -->
            <div class="card border-0 shadow-sm mb-4 sticky-sidebar">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Job Details</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-3 d-flex align-items-start">
                            <i class="fas fa-money-bill-wave text-success mt-1 me-3"></i>
                            <div>
                                <strong>Budget</strong><br>
                                {% if job.budget_type == 'fixed' %}
                                Fixed: ${{ job.budget|floatformat:2 }}
                                {% else %}
                                Hourly: ${{ job.budget|floatformat:2 }}/hr
                                {% endif %}
                            </div>
                        </li>
                        <li class="mb-3 d-flex align-items-start">
                            <i class="fas fa-map-marker-alt text-primary mt-1 me-3"></i>
                            <div>
                                <strong>Location</strong><br>
                                {{ job.location }}
                            </div>
                        </li>
                        <li class="mb-3 d-flex align-items-start">
                            <i class="fas fa-calendar-alt text-warning mt-1 me-3"></i>
                            <div>
                                <strong>Posted On</strong><br>
                                {{ job.created_at|date:"F d, Y" }}
                            </div>
                        </li>
                        <li class="mb-3 d-flex align-items-start">
                            <i class="fas fa-clock text-info mt-1 me-3"></i>
                            <div>
                                <strong>Duration</strong><br>
                                {{ job.duration|default:"Flexible" }}
                            </div>
                        </li>
                        <li class="mb-3 d-flex align-items-start">
                            <i class="fas fa-tag text-danger mt-1 me-3"></i>
                            <div>
                                <strong>Category</strong><br>
                                {{ job.get_category_display }}
                            </div>
                        </li>
                        <li class="d-flex align-items-start">
                            <i class="fas fa-chart-line text-purple mt-1 me-3"></i>
                            <div>
                                <strong>Status</strong><br>
                                <span class="badge {% if job.status == 'open' %}bg-success{% elif job.status == 'in_progress' %}bg-primary{% elif job.status == 'completed' %}bg-secondary{% else %}bg-danger{% endif %}">
                                    {{ job.get_status_display }}
                                </span>
                            </div>
                        </li>
                    </ul>
                </div>
                {% if not is_owner and user.is_authenticated and job.status == 'open' and not has_applied %}
                <div class="card-footer bg-white border-top">
                    <a href="{% url 'jobs:apply' job.id %}" class="btn btn-success w-100">
                        <i class="fas fa-paper-plane me-2"></i>Apply Now
                    </a>
                </div>
                {% endif %}
            </div>

            <!-- Related Jobs -->
            {% if related_jobs %}
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-briefcase me-2"></i>Related Jobs</h5>
                </div>
                <div class="card-body">
                    {% for related_job in related_jobs %}
                    <div class="mb-3 pb-3 {% if not forloop.last %}border-bottom{% endif %}">
                        <h6 class="mb-1">
                            <a href="{% url 'jobs:detail' related_job.id %}" class="text-decoration-none">
                                {{ related_job.title }}
                            </a>
                        </h6>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt me-1"></i>{{ related_job.location }}
                            </small>
                            <span class="badge {% if related_job.budget_type == 'fixed' %}bg-success{% else %}bg-warning{% endif %}">
                                ${{ related_job.budget }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                    <a href="{% url 'jobs:list' %}?category={{ job.category }}" class="btn btn-outline-primary btn-sm w-100">
                        View All {{ job.get_category_display }} Jobs
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Safety Tips -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Safety Tips</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled small text-muted mb-0">
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Never pay to apply for a job</li>
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Meet in public campus locations</li>
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Verify the employer's identity</li>
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Use campus escrow for payments</li>
                        <li><i class="fas fa-check-circle text-success me-2"></i>Report suspicious listings</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom CSS -->
<style>
    .sticky-sidebar {
        position: -webkit-sticky;
        position: sticky;
        top: 20px;
    }
    .avatar-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
    }
    .job-description {
        line-height: 1.8;
        font-size: 1.05rem;
    }
    .job-description p {
        margin-bottom: 1rem;
    }
    .stat-card {
        transition: transform 0.3s;
    }
    .stat-card:hover {
        transform: translateY(-3px);
    }
    .skills-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    .text-purple {
        color: #6f42c1;
    }
</style>

<!-- Fixed JavaScript -->
<script>
    // Save Job functionality
    document.addEventListener('DOMContentLoaded', function() {
        const saveJobBtn = document.getElementById('saveJobBtn');
        if (saveJobBtn) {
            saveJobBtn.addEventListener('click', function() {
                const btn = this;
                const icon = btn.querySelector('i');
                const jobId = {{ job.id }};  // Get job ID from Django template

                // Toggle saved state
                if (icon.classList.contains('far')) {
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    btn.innerHTML = '<i class="fas fa-bookmark me-2"></i>Saved';
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-success');

                    // Show success message
                    showToast('Job saved to your favorites!', 'success');

                    // Save to localStorage
                    localStorage.setItem('saved_job_' + jobId, 'true');
                } else {
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                    btn.innerHTML = '<i class="far fa-bookmark me-2"></i>Save Job';
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-secondary');

                    // Remove from localStorage
                    localStorage.removeItem('saved_job_' + jobId);
                }
            });

            // Check if job is already saved on page load
            const jobId = {{ job.id }};
            const isSaved = localStorage.getItem('saved_job_' + jobId);
            if (isSaved) {
                const btn = saveJobBtn;
                const icon = btn.querySelector('i');
                icon.classList.remove('far');
                icon.classList.add('fas');
                btn.innerHTML = '<i class="fas fa-bookmark me-2"></i>Saved';
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-success');
            }
        }

        // Share functionality
        const shareFacebook = document.getElementById('shareFacebook');
        if (shareFacebook) {
            shareFacebook.addEventListener('click', function(e) {
                e.preventDefault();
                const url = encodeURIComponent(window.location.href);
                window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
            });
        }

        const shareTwitter = document.getElementById('shareTwitter');
        if (shareTwitter) {
            shareTwitter.addEventListener('click', function(e) {
                e.preventDefault();
                const url = encodeURIComponent(window.location.href);
                const text = encodeURIComponent("Check out this job: {{ job.title }}");
                window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank');
            });
        }

        const copyLinkBtn = document.getElementById('copyLink');
        if (copyLinkBtn) {
            copyLinkBtn.addEventListener('click', function(e) {
                e.preventDefault();
                navigator.clipboard.writeText(window.location.href).then(() => {
                    showToast('Link copied to clipboard!', 'success');
                });
            });
        }
    });

    // Toast notification function
    function showToast(message, type = 'info') {
        // Remove existing toasts
        const existingToasts = document.querySelector('.toast-container');
        if (existingToasts) existingToasts.remove();

        // Create toast container
        const toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';

        // Create toast
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'info'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');

        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;

        toastContainer.appendChild(toast);
        document.body.appendChild(toastContainer);

        // Show toast
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();

        // Remove after 5 seconds
        setTimeout(() => {
            toastContainer.remove();
        }, 5000);
    }
</script>
{% endblock %}