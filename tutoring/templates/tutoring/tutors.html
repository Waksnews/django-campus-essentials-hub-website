{% extends 'core/base.html' %}
{% load static %}

{% block title %}Find Tutors - Campus Tutoring{% endblock %}

{% block extra_css %}
<style>
    .tutor-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: none;
        overflow: hidden;
    }
    .tutor-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .tutor-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #fff;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .rating-stars {
        color: #ffc107;
        font-size: 0.9rem;
    }
    .subject-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        padding: 4px 12px;
        font-size: 0.8rem;
    }
    .filter-sidebar {
        position: sticky;
        top: 20px;
    }
    .availability-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    .available {
        background-color: #28a745;
    }
    .busy {
        background-color: #dc3545;
    }
    .rate-badge {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-radius: 10px;
        padding: 2px 8px;
        font-size: 0.8rem;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-5 bg-light">
    <div class="container">
        <!-- Header -->
        <div class="row mb-5">
            <div class="col-12 text-center">
                <h1 class="display-5 fw-bold mb-3">Find Expert Tutors</h1>
                <p class="lead text-muted mb-4">
                    Connect with top student tutors across various subjects and levels
                </p>

                <!-- Quick Stats -->
                <div class="row justify-content-center mb-4">
                    <div class="col-auto">
                        <div class="card border-0 bg-white shadow-sm px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="fas fa-users fa-2x text-primary"></i>
                                </div>
                                <div>
                                    <h3 class="mb-0 fw-bold">{{ stats.total_tutors }}</h3>
                                    <small class="text-muted">Available Tutors</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="card border-0 bg-white shadow-sm px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="fas fa-star fa-2x text-warning"></i>
                                </div>
                                <div>
                                    <h3 class="mb-0 fw-bold">{{ stats.average_rate|floatformat:1 }}</h3>
                                    <small class="text-muted">Avg. Rating</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="card border-0 bg-white shadow-sm px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="fas fa-graduation-cap fa-2x text-success"></i>
                                </div>
                                <div>
                                    <h3 class="mb-0 fw-bold">{{ stats.total_hours|floatformat:0 }}</h3>
                                    <small class="text-muted">Hours Tutored</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Filters Sidebar -->
            <div class="col-lg-3 mb-4">
                <div class="card border-0 shadow-sm filter-sidebar">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filters</h5>
                    </div>
                    <div class="card-body">
                        <form method="GET" id="filterForm">
                            <!-- Search -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Search</label>
                                <input type="text"
                                       name="search"
                                       class="form-control"
                                       placeholder="Name, subject, keyword..."
                                       value="{{ search_query }}">
                            </div>

                            <!-- Subject Filter -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Subject</label>
                                <select name="subject" class="form-select">
                                    <option value="">All Subjects</option>
                                    {% for subject in subjects %}
                                    <option value="{{ subject.id }}"
                                            {% if selected_subject == subject.id|stringformat:"i" %}selected{% endif %}>
                                        {{ subject.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Year Level -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Tutor Level</label>
                                <select name="level" class="form-select">
                                    <option value="">All Levels</option>
                                    {% for level_val, level_name in tutor_levels %}
                                    <option value="{{ level_val }}"
                                            {% if selected_level == level_val %}selected{% endif %}>
                                        {{ level_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Hourly Rate Range -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Hourly Rate</label>
                                <div class="row">
                                    <div class="col-6">
                                        <input type="number"
                                               name="min_rate"
                                               class="form-control"
                                               placeholder="Min"
                                               min="0"
                                               value="{{ request.GET.min_rate }}">
                                    </div>
                                    <div class="col-6">
                                        <input type="number"
                                               name="max_rate"
                                               class="form-control"
                                               placeholder="Max"
                                               min="0"
                                               value="{{ request.GET.max_rate }}">
                                    </div>
                                </div>
                            </div>

                            <!-- Sort By -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Sort By</label>
                                <select name="sort" class="form-select">
                                    <option value="rating" {% if selected_sort == 'rating' %}selected{% endif %}>
                                        Highest Rated
                                    </option>
                                    <option value="rate_low" {% if selected_sort == 'rate_low' %}selected{% endif %}>
                                        Price: Low to High
                                    </option>
                                    <option value="rate_high" {% if selected_sort == 'rate_high' %}selected{% endif %}>
                                        Price: High to Low
                                    </option>
                                    <option value="experience" {% if selected_sort == 'experience' %}selected{% endif %}>
                                        Most Experienced
                                    </option>
                                    <option value="newest" {% if selected_sort == 'newest' %}selected{% endif %}>
                                        Newest First
                                    </option>
                                </select>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-2"></i>Apply Filters
                                </button>
                                <a href="{% url 'tutoring:tutors' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-2"></i>Clear Filters
                                </a>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Become Tutor CTA -->
                <div class="card border-0 shadow-sm mt-4 bg-gradient text-white"
                     style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="card-body text-center">
                        <h5 class="mb-3">Become a Tutor</h5>
                        <p class="small mb-3">
                            Share your knowledge and earn money helping other students
                        </p>
                        <a href="{% url 'tutoring:become_tutor' %}" class="btn btn-light btn-sm">
                            <i class="fas fa-user-graduate me-1"></i>Apply Now
                        </a>
                    </div>
                </div>
            </div>

            <!-- Tutors List -->
            <div class="col-lg-9">
                <!-- Results Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="mb-0">Available Tutors</h4>
                        <small class="text-muted">
                            Showing {{ tutors.start_index }}-{{ tutors.end_index }} of {{ tutors.paginator.count }} tutors
                        </small>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-primary active">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button type="button" class="btn btn-outline-primary">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>

                {% if tutors %}
                <div class="row">
                    {% for tutor in tutors %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card tutor-card h-100 border-0 shadow-sm">
                            <!-- Tutor Header -->
                            <div class="card-header bg-white border-bottom-0 pb-0 position-relative">
                                <div class="d-flex align-items-center">
                                    <!-- Avatar -->
                                    <div class="flex-shrink-0">
                                        {% if tutor.profile_picture %}
                                        <img src="{{ tutor.profile_picture.url }}"
                                             alt="{{ tutor.user.username }}"
                                             class="tutor-avatar">
                                        {% else %}
                                        <div class="tutor-avatar bg-primary text-white d-flex align-items-center justify-content-center">
                                            {{ tutor.user.first_name|first|upper }}{{ tutor.user.last_name|first|upper }}
                                        </div>
                                        {% endif %}
                                    </div>

                                    <!-- Info -->
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-1 fw-bold">{{ tutor.full_name }}</h6>
                                        <div class="d-flex align-items-center">
                                            <span class="rating-stars me-2">
                                                {{ tutor.rating|floatformat:1 }}
                                                <i class="fas fa-star"></i>
                                            </span>
                                            <span class="badge bg-light text-dark">
                                                {{ tutor.total_reviews }} reviews
                                            </span>
                                        </div>
                                        <div class="mt-1">
                                            <span class="availability-dot {% if tutor.is_available %}available{% else %}busy{% endif %}"></span>
                                            <small class="text-muted">
                                                {% if tutor.is_available %}Available{% else %}Busy{% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Rate Badge -->
                                <div class="position-absolute top-0 end-0 mt-2 me-2">
                                    <span class="rate-badge">${{ tutor.hourly_rate }}/hr</span>
                                </div>
                            </div>

                            <!-- Card Body -->
                            <div class="card-body">
                                <!-- Primary Subject -->
                                <div class="mb-3">
                                    <strong>Primary Subject:</strong>
                                    <div class="subject-badge d-inline-block ms-2">
                                        {{ tutor.primary_subject.name|default:"Not specified" }}
                                    </div>
                                </div>

                                <!-- Bio Excerpt -->
                                <p class="card-text small text-muted mb-3">
                                    {{ tutor.bio|truncatechars:100 }}
                                </p>

                                <!-- Stats -->
                                <div class="row text-center mb-3">
                                    <div class="col-4">
                                        <div class="fw-bold">{{ tutor.total_sessions }}</div>
                                        <small class="text-muted">Sessions</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="fw-bold">{{ tutor.year_of_study|title }}</div>
                                        <small class="text-muted">Level</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="fw-bold">{{ tutor.total_hours|floatformat:0 }}</div>
                                        <small class="text-muted">Hours</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Card Footer -->
                            <div class="card-footer bg-white border-top-0 pt-0">
                                <div class="d-grid gap-2">
                                    <a href="{% url 'tutoring:tutor_detail' tutor.id %}"
                                       class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-eye me-1"></i>View Profile
                                    </a>
                                    {% if tutor.is_available %}
                                    <a href="{% url 'tutoring:book_session' tutor.id %}"
                                       class="btn btn-primary btn-sm">
                                        <i class="fas fa-calendar-plus me-1"></i>Book Session
                                    </a>
                                    {% else %}
                                    <button class="btn btn-secondary btn-sm" disabled>
                                        <i class="fas fa-clock me-1"></i>Not Available
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                {% if tutors.has_other_pages %}
                <nav aria-label="Tutor pagination" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if tutors.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ tutors.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                        {% endif %}

                        {% for num in tutors.paginator.page_range %}
                            {% if tutors.number == num %}
                            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                            {% elif num > tutors.number|add:'-3' and num < tutors.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    {{ num }}
                                </a>
                            </li>
                            {% endif %}
                        {% endfor %}

                        {% if tutors.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ tutors.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

                {% else %}
                <!-- No Results -->
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-user-graduate fa-4x text-muted"></i>
                    </div>
                    <h4 class="mb-3">No tutors found</h4>
                    <p class="text-muted mb-4">
                        Try adjusting your filters or search terms
                    </p>
                    <a href="{% url 'tutoring:tutors' %}" class="btn btn-primary">
                        <i class="fas fa-times me-2"></i>Clear All Filters
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Filters -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-submit filter form on select change
        const filterForm = document.getElementById('filterForm');
        const autoSubmitFields = filterForm.querySelectorAll('select, input[type="number"]');

        autoSubmitFields.forEach(field => {
            field.addEventListener('change', function() {
                filterForm.submit();
            });
        });

        // Rate range validation
        const minRate = document.querySelector('input[name="min_rate"]');
        const maxRate = document.querySelector('input[name="max_rate"]');

        if (minRate && maxRate) {
            minRate.addEventListener('change', function() {
                if (maxRate.value && parseInt(this.value) > parseInt(maxRate.value)) {
                    this.value = maxRate.value;
                }
            });

            maxRate.addEventListener('change', function() {
                if (minRate.value && parseInt(this.value) < parseInt(minRate.value)) {
                    this.value = minRate.value;
                }
            });
        }
    });
</script>
{% endblock %}