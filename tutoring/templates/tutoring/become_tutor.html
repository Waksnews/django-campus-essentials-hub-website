{% extends 'core/base.html' %}
{% load static %}

{% block title %}Become a Tutor - Campus Tutoring{% endblock %}

{% block extra_css %}
<style>
    .registration-card {
        border: none;
        border-radius: 15px;
        overflow: hidden;
    }
    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 40px;
        position: relative;
    }
    .step-indicator::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 3px;
        background: #e9ecef;
        z-index: 1;
    }
    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 2;
        flex: 1;
    }
    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e9ecef;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 10px;
        transition: all 0.3s;
    }
    .step.active .step-number {
        background: #0d6efd;
        color: white;
        transform: scale(1.1);
    }
    .step.completed .step-number {
        background: #198754;
        color: white;
    }
    .step-label {
        font-size: 0.9rem;
        color: #6c757d;
        text-align: center;
    }
    .step.active .step-label {
        color: #0d6efd;
        font-weight: bold;
    }
    .form-section {
        display: none;
    }
    .form-section.active {
        display: block;
        animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .subject-checkbox {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
    }
    .subject-checkbox:hover {
        border-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.05);
    }
    .subject-checkbox.selected {
        border-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.1);
    }
    .form-check-input:checked + .subject-checkbox {
        border-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.1);
    }
    .rate-slider {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: #e9ecef;
        outline: none;
    }
    .rate-slider::-webkit-slider-thumb {
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #0d6efd;
        cursor: pointer;
    }
    .rate-display {
        font-size: 2rem;
        font-weight: bold;
        color: #0d6efd;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="display-6 fw-bold mb-3">Become a Campus Tutor</h1>
                <p class="lead text-muted">
                    Share your knowledge, help fellow students, and earn money!
                </p>
            </div>

            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Personal Info</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Subjects & Rates</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Qualifications</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Review & Submit</div>
                </div>
            </div>

            <!-- Registration Form -->
            <div class="card registration-card shadow-sm">
                <div class="card-body p-4 p-md-5">
                    {% if messages %}
                    <div class="messages mb-4">
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <form method="POST" enctype="multipart/form-data" id="tutorForm">
                        {% csrf_token %}

                        <!-- Step 1: Personal Info -->
                        <div class="form-section active" data-step="1">
                            <h4 class="mb-4">Personal Information</h4>

                            <div class="row mb-4">
                                <!-- Profile Picture -->
                                <div class="col-md-4 mb-4">
                                    <label class="form-label fw-bold">Profile Picture</label>
                                    <div class="text-center">
                                        <div class="profile-preview mb-3">
                                            <div class="avatar-preview rounded-circle bg-light border d-flex align-items-center justify-content-center mx-auto"
                                                 style="width: 150px; height: 150px; overflow: hidden;">
                                                <i class="fas fa-user fa-3x text-muted"></i>
                                                <img id="profilePreview" class="img-fluid d-none" alt="Preview">
                                            </div>
                                        </div>
                                        {{ form.profile_picture }}
                                        <div class="form-text">
                                            Recommended: 400x400px, Max 5MB
                                        </div>
                                    </div>
                                </div>

                                <!-- Basic Info -->
                                <div class="col-md-8">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-bold">Year of Study</label>
                                            {{ form.year_of_study }}
                                            {% if form.year_of_study.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.year_of_study.errors %}{{ error }}{% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-bold">Primary Subject</label>
                                            {{ form.primary_subject }}
                                            {% if form.primary_subject.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.primary_subject.errors %}{{ error }}{% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Contact Info -->
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-bold">Contact Email</label>
                                            {{ form.contact_email }}
                                            <div class="form-text">Optional: Different from account email</div>
                                            {% if form.contact_email.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.contact_email.errors %}{{ error }}{% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-bold">Contact Phone</label>
                                            {{ form.contact_phone }}
                                            <div class="form-text">Optional: For direct contact</div>
                                            {% if form.contact_phone.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.contact_phone.errors %}{{ error }}{% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Preferred Contact Method</label>
                                        {{ form.preferred_contact }}
                                        {% if form.preferred_contact.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.preferred_contact.errors %}{{ error }}{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Navigation -->
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary" disabled>Previous</button>
                                <button type="button" class="btn btn-primary next-step" data-next="2">
                                    Next: Subjects & Rates <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Subjects & Rates -->
                        <div class="form-section" data-step="2">
                            <h4 class="mb-4">Subjects & Rates</h4>

                            <!-- Subjects -->
                            <div class="mb-4">
                                <label class="form-label fw-bold mb-3">Select Subjects You Can Tutor</label>
                                <p class="text-muted mb-3">Select all subjects you're comfortable teaching</p>

                                <div class="row">
                                    {% for subject in form.subjects.field.queryset %}
                                    <div class="col-md-4 col-sm-6 mb-3">
                                        <div class="subject-checkbox">
                                            <input type="checkbox"
                                                   name="subjects"
                                                   value="{{ subject.id }}"
                                                   id="subject_{{ subject.id }}"
                                                   class="form-check-input d-none">
                                            <label for="subject_{{ subject.id }}" class="mb-0 d-block">
                                                <div class="d-flex align-items-center">
                                                    <div class="me-3">
                                                        <i class="{{ subject.icon|default:'fas fa-book' }} fa-lg"></i>
                                                    </div>
                                                    <div>
                                                        <strong>{{ subject.name }}</strong>
                                                        <div class="small text-muted">{{ subject.category }}</div>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="col-12">
                                        <div class="alert alert-warning">
                                            No subjects available. Please contact admin.
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% if form.subjects.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.subjects.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Hourly Rate -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Set Your Hourly Rate</label>
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <div class="rate-display text-center mb-3 mb-md-0">
                                            $<span id="rateValue">{{ form.hourly_rate.value|default:20 }}</span>/hr
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.hourly_rate }}
                                        <div class="d-flex justify-content-between small text-muted mt-2">
                                            <span>$5/hr</span>
                                            <span>$100/hr</span>
                                        </div>
                                        {% if form.hourly_rate.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.hourly_rate.errors %}{{ error }}{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="form-text">
                                    Competitive rates: Students typically pay $15-$40 per hour
                                </div>
                            </div>

                            <!-- Navigation -->
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary prev-step" data-prev="1">
                                    <i class="fas fa-arrow-left me-2"></i>Previous
                                </button>
                                <button type="button" class="btn btn-primary next-step" data-next="3">
                                    Next: Qualifications <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 3: Qualifications -->
                        <div class="form-section" data-step="3">
                            <h4 class="mb-4">Qualifications & Experience</h4>

                            <!-- Bio -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">About You</label>
                                {{ form.bio }}
                                <div class="form-text">
                                    Introduce yourself! Tell students about your teaching style, personality, and why you'd be a great tutor.
                                </div>
                                {% if form.bio.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.bio.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Qualifications -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Qualifications</label>
                                {{ form.qualifications }}
                                <div class="form-text">
                                    List your relevant courses, certifications, grades, or achievements.
                                </div>
                                {% if form.qualifications.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.qualifications.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Teaching Experience -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Teaching Experience</label>
                                {{ form.teaching_experience }}
                                <div class="form-text">
                                    Describe any previous tutoring or teaching experience.
                                </div>
                                {% if form.teaching_experience.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.teaching_experience.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Navigation -->
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary prev-step" data-prev="2">
                                    <i class="fas fa-arrow-left me-2"></i>Previous
                                </button>
                                <button type="button" class="btn btn-primary next-step" data-next="4">
                                    Next: Review & Submit <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 4: Review -->
                        <div class="form-section" data-step="4">
                            <h4 class="mb-4">Review & Submit</h4>

                            <!-- Summary -->
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="card-title mb-3">Application Summary</h5>

                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <strong>Year of Study:</strong>
                                            <div id="reviewYear" class="text-muted"></div>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Primary Subject:</strong>
                                            <div id="reviewPrimarySubject" class="text-muted"></div>
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <strong>Hourly Rate:</strong>
                                            <div id="reviewRate" class="text-muted"></div>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Subjects:</strong>
                                            <div id="reviewSubjects" class="text-muted"></div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <strong>About You:</strong>
                                        <div id="reviewBio" class="text-muted"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Terms -->
                            <div class="form-check mb-4">
                                <input class="form-check-input" type="checkbox" id="terms" required>
                                <label class="form-check-label" for="terms">
                                    I agree to the <a href="#" class="text-decoration-none">Tutor Agreement</a> and confirm that all information provided is accurate.
                                </label>
                            </div>

                            <!-- Navigation -->
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary prev-step" data-prev="3">
                                    <i class="fas fa-arrow-left me-2"></i>Previous
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-paper-plane me-2"></i>Submit Application
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Benefits Section -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-body">
                    <h5 class="mb-4">Why Become a Campus Tutor?</h5>
                    <div class="row">
                        <div class="col-md-3 text-center mb-3">
                            <div class="mb-3">
                                <i class="fas fa-money-bill-wave fa-2x text-success"></i>
                            </div>
                            <h6>Earn Money</h6>
                            <p class="small text-muted">Set your own rates and earn on your schedule</p>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="mb-3">
                                <i class="fas fa-graduation-cap fa-2x text-primary"></i>
                            </div>
                            <h6>Reinforce Learning</h6>
                            <p class="small text-muted">Teaching helps deepen your own understanding</p>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="mb-3">
                                <i class="fas fa-users fa-2x text-warning"></i>
                            </div>
                            <h6>Build Network</h6>
                            <p class="small text-muted">Connect with students and build relationships</p>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="mb-3">
                                <i class="fas fa-award fa-2x text-danger"></i>
                            </div>
                            <h6>Enhance Resume</h6>
                            <p class="small text-muted">Add valuable teaching experience to your profile</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Profile picture preview
        const profileInput = document.querySelector('input[name="profile_picture"]');
        const profilePreview = document.getElementById('profilePreview');
        const avatarPreview = document.querySelector('.avatar-preview i');

        if (profileInput) {
            profileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        profilePreview.src = e.target.result;
                        profilePreview.classList.remove('d-none');
                        avatarPreview.classList.add('d-none');
                    }
                    reader.readAsDataURL(file);
                }
            });
        }

        // Hourly rate slider
        const rateInput = document.querySelector('input[name="hourly_rate"]');
        const rateValue = document.getElementById('rateValue');

        if (rateInput && rateValue) {
            rateInput.addEventListener('input', function() {
                rateValue.textContent = this.value;
            });
        }

        // Step navigation
        const steps = document.querySelectorAll('.step');
        const formSections = document.querySelectorAll('.form-section');
        const nextButtons = document.querySelectorAll('.next-step');
        const prevButtons = document.querySelectorAll('.prev-step');

        function goToStep(stepNumber) {
            // Update step indicator
            steps.forEach(step => {
                const stepNum = parseInt(step.dataset.step);
                step.classList.remove('active', 'completed');

                if (stepNum < stepNumber) {
                    step.classList.add('completed');
                } else if (stepNum === stepNumber) {
                    step.classList.add('active');
                }
            });

            // Show/hide form sections
            formSections.forEach(section => {
                section.classList.remove('active');
                if (parseInt(section.dataset.step) === stepNumber) {
                    section.classList.add('active');
                }
            });

            // Update review summary
            if (stepNumber === 4) {
                updateReviewSummary();
            }
        }

        // Next button click
        nextButtons.forEach(button => {
            button.addEventListener('click', function() {
                const currentSection = this.closest('.form-section');
                const currentStep = parseInt(currentSection.dataset.step);
                const nextStep = parseInt(this.dataset.next);

                // Validate current step
                if (validateStep(currentStep)) {
                    goToStep(nextStep);
                }
            });
        });

        // Previous button click
        prevButtons.forEach(button => {
            button.addEventListener('click', function() {
                const prevStep = parseInt(this.dataset.prev);
                goToStep(prevStep);
            });
        });

        // Subject checkbox styling
        const subjectCheckboxes = document.querySelectorAll('.subject-checkbox input[type="checkbox"]');
        subjectCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const label = this.closest('.subject-checkbox');
                if (this.checked) {
                    label.classList.add('selected');
                } else {
                    label.classList.remove('selected');
                }
            });
        });

        // Update review summary
        function updateReviewSummary() {
            // Year of study
            const yearSelect = document.querySelector('select[name="year_of_study"]');
            if (yearSelect) {
                const selectedOption = yearSelect.options[yearSelect.selectedIndex];
                document.getElementById('reviewYear').textContent = selectedOption.text;
            }

            // Primary subject
            const primarySubjectSelect = document.querySelector('select[name="primary_subject"]');
            if (primarySubjectSelect) {
                const selectedOption = primarySubjectSelect.options[primarySubjectSelect.selectedIndex];
                document.getElementById('reviewPrimarySubject').textContent = selectedOption.text;
            }

            // Hourly rate
            if (rateValue) {
                document.getElementById('reviewRate').textContent = `$${rateValue.textContent}/hour`;
            }

            // Selected subjects
            const selectedSubjects = Array.from(
                document.querySelectorAll('.subject-checkbox input[type="checkbox"]:checked')
            ).map(cb => {
                const label = cb.nextElementSibling.querySelector('strong');
                return label ? label.textContent : '';
            }).filter(text => text);

            document.getElementById('reviewSubjects').textContent =
                selectedSubjects.length > 0 ? selectedSubjects.join(', ') : 'No subjects selected';

            // Bio
            const bioTextarea = document.querySelector('textarea[name="bio"]');
            if (bioTextarea) {
                document.getElementById('reviewBio').textContent = bioTextarea.value || 'Not provided';
            }
        }

        // Step validation
        function validateStep(step) {
            let isValid = true;

            switch(step) {
                case 1:
                    // Validate required fields in step 1
                    const requiredStep1 = document.querySelectorAll('[data-step="1"] [required]');
                    requiredStep1.forEach(field => {
                        if (!field.value.trim()) {
                            field.classList.add('is-invalid');
                            isValid = false;
                        } else {
                            field.classList.remove('is-invalid');
                        }
                    });
                    break;

                case 2:
                    // Validate at least one subject selected
                    const selectedSubjects = document.querySelectorAll('.subject-checkbox input[type="checkbox"]:checked');
                    if (selectedSubjects.length === 0) {
                        alert('Please select at least one subject you can tutor.');
                        isValid = false;
                    }
                    break;

                case 3:
                    // Validate bio and qualifications
                    const bio = document.querySelector('textarea[name="bio"]');
                    const qualifications = document.querySelector('textarea[name="qualifications"]');

                    if (!bio.value.trim()) {
                        bio.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        bio.classList.remove('is-invalid');
                    }

                    if (!qualifications.value.trim()) {
                        qualifications.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        qualifications.classList.remove('is-invalid');
                    }
                    break;
            }

            if (!isValid) {
                alert('Please fill in all required fields before proceeding.');
            }

            return isValid;
        }

        // Form submission
        const form = document.getElementById('tutorForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                const terms = document.getElementById('terms');
                if (!terms.checked) {
                    e.preventDefault();
                    alert('Please agree to the terms and conditions.');
                    terms.focus();
                    return false;
                }
                return true;
            });
        }
    });
</script>
{% endblock %}